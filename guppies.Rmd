---
title: "Okinawa guppies"
author: "Sasha Mikheyev"
date: "10/30/2018"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 5
    theme: cerulean
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(asreml)
library(tidyverse)
library(rrBLUP)
library(MCMCglmm)
```

## Site structure
```{r}
mds <- read_table("data/all.mds") %>% separate(FID, c("site", "ind"), extra = "merge") %>% select(site, id = IID, C1, C2)
ggplot(mds, aes(C1, C2, color=site)) + geom_point() + scale_color_brewer(type='qual')+theme_bw()
dropSuspicious = c("site2_male54", "site2_male16", "site1_male55", "site1_male23")
ggplot(filter(mds, ! id %in% dropSuspicious), aes(C1, C2, color=site)) + geom_point()
```

Looks like there are some individuals may have been switched, and we'll drop them just in case, though the full analysis is presented [below](link](###-re-run-with-all-data)).

## Read phenotypic data from VCFtools
filtered using vcftools ` --mac 10 --max-missing 0.5 --minQ 20 --minDP 6 `
```{r}
pheno <- read_tsv("data/guppy pheno.tsv", col_types = cols()) %>% mutate(orange=rowMeans(cbind(L_Orangearea, R_Orangearea), na.rm=T), site = factor(Site)) %>% select(site, Label, orange, TopBottom) %>% left_join(read_csv("data/geno2pheno.csv", col_types = cols()), by=c("Label" = "pheno")) %>% left_join(read_tsv("data/out.het", col_types = cols()) %>% mutate(het = 1 - `O(HOM)`/ N_SITES) %>% select(gen = INDV, het, F, nsites = N_SITES)) %>% na.omit() %>% filter(! gen %in% dropSuspicious)
ggplot(pheno, aes(het, orange, color=site))+geom_point()
summary(lm(orange ~ het + site, data = pheno))
```

## Read genotypes

We calculate the GRM and get it ready for asreml/mcmcglmm

```{r asreml}
indvs <- read_tsv("data/out.012.indv", col_names = c("gen")) %>% left_join(read_csv("data/geno2pheno.csv", col_types = cols())) 
pos <- read_tsv("data/out.012.pos", col_names = c("chrom", "pos"), col_types = "cn") %>% mutate(marker = paste(chrom, pos, sep = "_"))
gen <- cbind(indvs, read_tsv("data/out.012", col_names = F) - 1 ) %>% filter(! gen %in% dropSuspicious)
G <- A.mat(gen %>% select(-c(gen, pheno)))
heatmap(G)
# Add a small amount to the diagonal so G is invertable
diag(G) <- diag(G)+0.001
#Need to invert G for the mixed model equations
Ginv <- solve(G)
colnames(Ginv) <- gen$gen
rownames(Ginv) <- gen$gen

orangeModel <- asreml(fixed=orange~1+het+site,
random= ~giv(gen),
ginverse= list(gen  = Ginv),
data=pheno, control = asreml.control(maxiter=20))
summary(orangeModel,all=T)$coef.fi

summary(orangeModel)
summary(orangeModel)$varcomp
hist(orangeModel$residuals)

summary(orangeModel,all=T)$coef.fi
```

## Looking only at chromosome 12, the location of the sex locu
```{r chr12}
G12 <- A.mat(gen[,which(pos$chrom==12)+2])
diag(G12) <- diag(G12)+0.001
Ginv12 <- solve(G12)
names(Ginv12) <- gen$gen
rownames(Ginv12) <- gen$gen

orangeModel12 <- asreml(fixed=sqrt(orange)~1+het,
random= ~giv(gen),
ginverse= list(gen  = Ginv12),
data=pheno)
summary(orangeModel12,all=T)$coef.fi

hist(orangeModel12$residuals)
```

Nothing really interesting on chr12

```{r}
pin <- function (object, transform) {
  pframe <- as.list(object$gammas)
  names(pframe) <- paste("V", seq(1, length(pframe)), sep = "")
  tvalue <- eval(deriv(transform[[length(transform)]], names(pframe)),
                 pframe)
  X <- as.vector(attr(tvalue, "gradient"))
  X[object$gammas.type == 1] <- 0
  tname <- if (length(transform) == 3)
    transform[[2]]
  else ""
  n <- length(pframe)
  i <- rep(1:n, 1:n)
  j <- sequence(1:n)
  k <- 1 + (i > j)
  Vmat <- object$ai
  se <- sqrt(sum(Vmat * X[i] * X[j] * k))
  data.frame(row.names = tname, Estimate = tvalue, SE = se)
}


# use the pin function for functions of the variance components. 
#Here, V1 is the VA, V2 is VE, so V1/(V1+V2) gives the heritability
(h2 <- pin(orangeModel,h2~V1/(V1+V2)))

# if you want other fucntions (e.g. for corrrelations from a bivariate model)
# just modify the command for the respective variance components
```

```{r mcmcglmm, cache=T}
Ginv.1 <- as(Ginv, "dgCMatrix")
prior1.1 <- list(G = list(G1 = list(V = 1, nu = 0.002)), R = list(V = 1, nu = 0.002))
model1.1 <- MCMCglmm(orange ~ 1 + het + site , random = ~gen, ginverse = list(gen = Ginv.1), data = as.data.frame(pheno), prior = prior1.1, family = "gaussian", nitt = 100000, burnin = 3000)
summary(model1.1)
plot(model1.1)
posterior.heritability1.1 <- model1.1$VCV[, "gen"]/(model1.1$VCV[,
"gen"] + model1.1$VCV[, "units"])
HPDinterval(posterior.heritability1.1, 0.95)
```

## Re-run with all data

There were a couple of sites that were probably switched and may have incorrect data, but we'll re-run everything here to confirm that dropping them doesn't affect the results.

```{r reRun, cache=T}
pheno <- read_tsv("data/guppy pheno.tsv", col_types = cols()) %>% mutate(orange=rowMeans(cbind(L_Orangearea, R_Orangearea), na.rm=T), site = factor(Site)) %>% select(site, Label, orange, TopBottom) %>% left_join(read_csv("data/geno2pheno.csv", col_types = cols()), by=c("Label" = "pheno")) %>% left_join(read_tsv("data/out.het", col_types = cols()) %>% mutate(het = 1 - `O(HOM)`/ N_SITES) %>% select(gen = INDV, het, F, nsites = N_SITES)) %>% na.omit()
ggplot(pheno, aes(het, orange, color=site))+geom_point()
with(pheno, cor.test(het, orange, method="s"))
indvs <- read_tsv("data/out.012.indv", col_names = c("gen")) %>% left_join(read_csv("data/geno2pheno.csv", col_types = cols())) 
pos <- read_tsv("data/out.012.pos", col_names = c("chrom", "pos"), col_types = "cn") %>% mutate(marker = paste(chrom, pos, sep = "_"))
gen <- cbind(indvs, read_tsv("data/out.012", col_names = F) - 1 ) 
G <- A.mat(gen %>% select(-c(gen, pheno)))

# Add a small amount to the diagonal so G is invertable
diag(G) <- diag(G)+0.001
#Need to invert G for the mixed model equations
Ginv <- solve(G)
colnames(Ginv) <- gen$gen
rownames(Ginv) <- gen$gen

orangeModel <- asreml(fixed=orange~1+het+site,
random= ~giv(gen),
ginverse= list(gen  = Ginv),
data=pheno, control = asreml.control(maxiter=20))
summary(orangeModel,all=T)$coef.fi

Ginv.1 <- as(Ginv, "dgCMatrix")
prior1.1 <- list(G = list(G1 = list(V = 1, nu = 0.002)), R = list(V = 1, nu = 0.002))
model1.1 <- MCMCglmm(orange ~ 1 + het + site , random = ~gen, ginverse = list(gen = Ginv.1), data = as.data.frame(pheno), prior = prior1.1, family = "gaussian", nitt = 100000, burnin = 3000)
summary(model1.1)
```